
CREATE TABLE TABELA_RESTORES (COMANDO NVARCHAR(MAX), DATABASENAME NVARCHAR(MAX))
GO

CREATE PROCEDURE CRIACOMANDORESTORE (@ARQUIVOBACKUP VARCHAR (MAX)) AS
BEGIN

DECLARE @HEADER TABLE (BACKUPNAME VARCHAR(500),A2 VARCHAR(500),A3 VARCHAR(500),A4 VARCHAR(500),A5 VARCHAR(500),A6 VARCHAR(500),
A7 VARCHAR(500),A8 VARCHAR(500),A9 VARCHAR(500),DATABASENAME VARCHAR(500),A11 VARCHAR(500),A12 VARCHAR(500),A13 VARCHAR(500),
A14 VARCHAR(500),A15 VARCHAR(500),A16 VARCHAR(500),A17 VARCHAR(500),A18 VARCHAR(500),A19 VARCHAR(500),A20 VARCHAR(500),A21 VARCHAR(500),
A22 VARCHAR(500),A23 VARCHAR(500),A24 VARCHAR(500),A25 VARCHAR(500),A26 VARCHAR(500),A27 VARCHAR(500),A28 VARCHAR(500),A29 VARCHAR(500),
A30 VARCHAR(500),A31 VARCHAR(500),A32 VARCHAR(500),A33 VARCHAR(500),A34 VARCHAR(500),A35 VARCHAR(500),A36 VARCHAR(500),A37 VARCHAR(500),
A38 VARCHAR(500),A39 VARCHAR(500),A40 VARCHAR(500),A41 VARCHAR(500),A42 VARCHAR(500),A43 VARCHAR(500),A44 VARCHAR(500),A45 VARCHAR(500),
A46 VARCHAR(500),A47 VARCHAR(500),A48 VARCHAR(500),A49 VARCHAR(500),A50 VARCHAR(500),A51 VARCHAR(500),A52 VARCHAR(500),A53 VARCHAR(500),
A54 VARCHAR(500),A55 VARCHAR(500),A56 VARCHAR(500));
DECLARE @FILELIST TABLE (LOGICALNAME VARCHAR(500),Q CHAR(500),W CHAR(500),E CHAR(500),R CHAR(500),T CHAR(500),X CHAR(500),Y CHAR(500),U CHAR(500),I CHAR(500),O CHAR(500),P CHAR(500),A CHAR(500),S CHAR(500),
D CHAR(500),F CHAR(500),G CHAR(500),H CHAR(500),J CHAR(500),K CHAR(500),L CHAR(500),Z CHAR(500));
DECLARE @COMANDOHO NVARCHAR(MAX) = '';
DECLARE @COMANDOFLO NVARCHAR(MAX) = '';
DECLARE @COMANDORESTORE NVARCHAR(MAX) = '';
DECLARE @COMANDOFILES NVARCHAR(MAX) = '';
DECLARE @NOMEBANCO NVARCHAR(MAX);

SELECT 
	@COMANDOHO += CONCAT ('RESTORE HEADERONLY FROM DISK = ''', @ARQUIVOBACKUP, '''', CHAR(13)),
	@COMANDOFLO += CONCAT('RESTORE FILELISTONLY FROM DISK = ''', @ARQUIVOBACKUP, '''', CHAR(13))

	
--VERIFICA OS NOMES DOS ARQUIVOS DO BANCO
INSERT @FILELIST
EXEC SP_EXECUTESQL @COMANDOFLO;
SELECT @COMANDOFILES += CONCAT('MOVE N''', LOGICALNAME, ''' TO N''D:\MSSQL\DATA\', LOGICALNAME, '.MDF'', ')  FROM @FILELIST;

-- CRIA O COMANDO DO RESTORE
INSERT @HEADER
EXEC SP_EXECUTESQL @COMANDOHO
SELECT @COMANDORESTORE = 'RESTORE DATABASE ' + DATABASENAME + ' FROM DISK = N''' + BACKUPNAME + '.BAK'' WITH FILE = 1, '
	+ @COMANDOFILES + ' NOUNLOAD, NORECOVERY,  STATS = 5 ',
	@NOMEBANCO = DATABASENAME
FROM @HEADER

INSERT TABELA_RESTORES
SELECT @COMANDORESTORE AS COMANDORESTORE , @NOMEBANCO AS NOMEBANCO

END
GO

/* 
--RODA EM TODOS OS ARQUIVOS DE UMA PASTA
DELETE FROM TABELA_RESTORES

DECLARE @FILES TABLE (FILENAME VARCHAR(MAX), DEPTH INT, _FILE INT);
DECLARE @SQL NVARCHAR(MAX) = '';

INSERT @FILES 
EXEC MASTER.DBO.XP_DIRTREE 'E:\MSSQL\BACKUP\',1,1

DECLARE @TEXTO NVARCHAR(MAX);
DECLARE PONTEIRO CURSOR 
FOR 
	SELECT 'CRIACOMANDORESTORE ''' + FILENAME + '''' + CHAR(13)
	FROM @FILES
	WHERE FILENAME LIKE '%BAK';
OPEN PONTEIRO 
FETCH PONTEIRO INTO @TEXTO
WHILE (@@FETCH_STATUS = 0)
BEGIN
	PRINT @TEXTO
	EXECUTE SP_EXECUTESQL  @TEXTO; 
	FETCH NEXT FROM PONTEIRO INTO @TEXTO;		
END
CLOSE PONTEIRO;
DEALLOCATE PONTEIRO;	

*/